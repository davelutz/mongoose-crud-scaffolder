mongoose-scaffold-crud
======================

Simple Mongoose model, REST controller and Pug view code generator. Built
because the authors' google-foo is weakening (even though he knew he can't be
the only one needing this, there was nothing on the interwebs to help him out)
and he needed to kick-off another Express/Mongoose project.

The REST controller is built for Express 4, support may be added for 3 in
the future but it's not planned.

_Note: the project was built for specific needs, so it did not look into package.json etc - just generated simple files to get me started. This is not a fancy Yeoman generator that does it all._

# Usage

    npm install -g mongoose-scaffold-crud

    mongoose-scaffold-crud user name email age:number

It generates a Mongoose model, a REST controller and a simple Pug view.

# Details

## Model generator

The scaffolder takes at least one argument - model name.
By default, we add name the parameter to mongoose model.

Model example:

    'use strict';
    var mongoose = require('mongoose')
        , Schema = mongoose.Schema
        ;

    var usersSchema = new Schema({
        name: String,
        email: String,
        age: Number
    });

    module.exports = mongoose.model('users', usersSchema);`

## Controllers generator

The controller generated will export an express4 Router setup for the rest route. It will look like this:

    'use strict';

    /**
    * user controller file * autogenerated by mongoose-scaffold-crud **/

    var express = require('express');
    var router = express.Router();
    var Model = require('../models/model-users.js');

    router.get('/', function(req, res) {
        Model.find(function(err, users){
            if (req.accepts('html', 'json') === 'json') {
                if(err) {
                    return res.json(500, {
                        message: 'Error getting users.'
                    });
                }
                return res.json(users);
            } else {
                if(err) {
                    return res.send('500: Internal Server Error', 500);
                }
            return res.render('users/index', {users: users});
            }
        });
    });

    router.get('/edit', function(req, res) {
        return res.render('users/edit');
    });

    router.post('/', function(req, res) {
        var user = new Model({
            'name': req.body['name'],
            'email': req.body['email'],
            'age': req.body['age']
        });
        user.save(function(err, user){
            if (req.accepts('html', 'json') === 'json') {
                if(err) {
                    return res.json(500, {
                        message: 'Error saving item.',
                        error: err
                    });
                }
                return res.json({
                    message: 'saved',
                    _id: user._id
                });
            } else {
                if(err) {
                    return res.send('500: Internal Server Error', 500);
                }
                return res.render('users/edit', {user: user});
            }
        });
    });

    router.get('/:id', function(req, res) {
        var id = req.params.id;
        Model.findOne({_id: id}, function(err, user){
            if (req.accepts('html', 'json') === 'json') {
                if(err) {
                    return res.json(500, {
                        message: 'Error getting user.'
                    });
                }
                if(!user) {
                    return res.json(404, {
                        message: 'No such user.'
                    });
                }
                return res.json(user);
            } else {
                if(err) {
                    return res.send('500: Internal Server Error', 500);
                }
                if(!user) {
                    return res.end('No such user');
                }
                return res.render('users/edit', {user: user, flash: 'Created.'});
            }
        });
    });

    router.put('/:id', function(req, res) {
        var id = req.params.id;
        Model.findOne({_id: id}, function(err, user){
            if (req.accepts('html', 'json') === 'json') {
                if(err) {
                    return res.json(500, {
                        message: 'Error saving user',
                        error: err
                    });
                }
                if(!user) {
                    return res.json(404, {
                        message: 'No such user'
                    });
                }
                user['name'] = req.body['name'] ? req.body['name'] : user['name'];
                user['email'] = req.body['email'] ? req.body['email'] : user['email'];
                user['age'] = req.body['age'] ? req.body['age'] : user['age'];
                user.save(function(err, user){
                    if(err) {
                        return res.json(500, {
                            message: 'Error getting user.'
                        });
                    }
                    if(!user) {
                        return res.json(404, {
                            message: 'No such user'
                        });
                    }
                    return res.json(user);
                });
            } else {
                if(err) {
                    return res.send('500: Internal Server Error', 500);
                }
                if(!user) {
                    return res.end('No such user');
                }
                user['name'] = req.body['name'] ? req.body['name'] : user['name'];
                user['email'] = req.body['email'] ? req.body['email'] : user['email'];
                user['age'] = req.body['age'] ? req.body['age'] : user['age'];
                user.save(function(err, user){
                    if(err) {
                        return res.send('500: Internal Server Error', 500);
                    }
                    if(!user) {
                        return res.end('No such user');
                    }
                    return res.render('users/edit', {user: user, flash: 'Saved.'});
                });
            }
        });
    });

    router.delete('/:id', function(req, res) {
        var id = req.params.id;
        Model.remove({_id: id}, function(err, user){
            if (req.accepts('html', 'json') === 'json') {
                if(err) {
                    return res.json(500, {
                        message: 'Error getting user.'
                    });
                }
                if(!user) {
                    return res.json(404, {
                        message: 'No such user'
                    });
                }
                return res.json(user);
            } else {
                if(err) {
                    return res.send('500: Internal Server Error', 500);
                }
                if(!user) {
                    return res.end('No such user');
                }
                return res.render('index', {flash: 'Item deleted.'});
            }
        });
    });

    module.exports = router;


## View generator

This will generate two Pug files: one index.pug partial (layout file assumed
provided) with list of items, another is edit.pug, with a form for viewing,
editing or creating a single item.

Example of index.pug:


    extends ../layout

    block content

        h2 Users
        p View users or
            a(href="users/edit") Add a user

        table
            tr
                td Name
                td Email
                td Age
                td Actions
            each user in users
                tr
                    td #{user.name}
                    td #{user.email}
                    td #{user.age}
                    td
                        a(href="users/" + user._id) Edit


Example of edit.pug:


    extends ../layout

    block content

        h2 User form
        if user
            p Edit user
            - var userpassed = true
        else
            - var userpassed = false

        if user
            - var myAction = "/users/" + user._id + "?_method=PUT"
        else
            - var myAction = "/users"
            - user = {}
        form(name="userform", method="post", action=myAction)
            table
                tr
                    td Name
                        input(type="text", name="name", value=user.name)
                tr
                    td Email
                        input(type="text", name="email", value=user.email)
                tr
                    td Age
                        input(type="text", name="age", value=user.age)
                tr
                    td
                        input(type="submit", value="Save")

        if userpassed
            form(method="post", action="/users/" + user._id + "?_method=DELETE")
                input(type="submit", value="Delete")

# Express Integration
Add the following to app.js:

    var <model> = require('./routes/<model>');
    E.g.  var users = require('./routes/users');

- Place the controller file in the routes folder
- Place the model file in the models folder
- Place the views files in a subfolder of views named <model> (e.g. "users")

# ROADMAP

v0.1.0 - just get a dumb scaffolder working.
- model generator: create a models/model-<name>.js
- model generator: put code in there with all the fields required
- controller generator: create a controllers/ctrl-<name>.js
- controller generator: create an express4 Router in there for REST on the model
- views generator: create a views/<model>/index.pug and views/<model>/edit.pug
- views generator: generate HTML in there that will show a list of models

v0.2.0 - Fix bugs
- some bugs and stuff fixed

v0.3.0 Get it right
- fix the project name bug (mongoose-scaffold-crud is a dumb name)
- gather feedback on all the stupid things in code
- maybe take more arguments (ie generate controller only, accept
  unique/required params for fields etc)

